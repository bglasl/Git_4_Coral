print(plot)
graphics.off()
##### Piechart Figure_3 ####
# Piechart
load(file="PHYLOSEQ_TABLE.RData")
library(phyloseq)
PHYLOSEQ_TABLE_control=subset_samples(PHYLOSEQ_TABLE, Treatment!="field_control")
PHYLOSEQ_TABLE_control
#### PIECHART ####
OTU<-as.data.frame(otu_table(PHYLOSEQ_TABLE_control))
library(data.table)
setDT(OTU, keep.rownames = TRUE)[]
OTU<-dplyr::rename(OTU, Feature_ID=rn)
TAXA<-as.data.frame(tax_table(PHYLOSEQ_TABLE_control))
library(dplyr)
library(tidyr)
Piecharttable<-right_join(OTU, TAXA, by="Feature_ID")
Endos_all<-Piecharttable %>% filter(Genus=="D_5__Endozoicomonas") %>%
tidyr::gather("Sample","Abundance", 2:97) %>%
group_by(Sample) %>%
summarise(MEAN_Endo=sum(Abundance)) %>%
summarise(MEAN_Endo_total=mean(MEAN_Endo), SD=sd(MEAN_Endo))
Endos_all
source('http://bioconductor.org/biocLite.R')
biocLite('microbiome')
library(ggplot2)
library(phyloseq)
load(file="PHYLOSEQ_TABLE.RData")
PHYLOSEQ_TABLE_control=subset_samples(PHYLOSEQ_TABLE, Treatment!="field_control")
PHYLOSEQ_TABLE_control
#remove field_control samples
PHYLOSEQ_TABLE_control=subset_samples(PHYLOSEQ_TABLE, Treatment!="field_control")
PHYLOSEQ_TABLE_control
#### Boxplot - rel.abund/Genotype ####
Endos<-Piecharttable %>% filter(Genus=="D_5__Endozoicomonas") %>%
filter(Feature_ID!="c0e6c66cfd0673747e59936d6c050407") %>%
tidyr::gather("SAMPLE","Abundance", 2:97) %>%
group_by(SAMPLE) %>%summarise(Endozoicomonas=sum(Abundance))
Core<-Piecharttable %>% filter(Feature_ID=="c0e6c66cfd0673747e59936d6c050407") %>%
tidyr::gather("SAMPLE","Abundance", 2:97) %>%
group_by(SAMPLE) %>%summarise(core=sum(Abundance))
SAMPLEDATA<-data.frame(sample_data(PHYLOSEQ_TABLE_control))
Endo_table<-inner_join(SAMPLEDATA,Endos, by="SAMPLE")
Endo_table<-inner_join(Endo_table, Core, by="SAMPLE")
Endo_table_melt<-Endo_table %>% select(-PSYield, -Chla, -Zoox, -Protein)
Endo_table_melt<-melt(Endo_table_melt)
plot1<-ggplot(Endo_table_melt, aes(x=variable, y=value, fill=variable))+
facet_wrap(~Genotype)+
geom_boxplot()+
theme_classic(base_size = 16, base_family = "Helvetica")+
scale_fill_brewer(palette = "Paired")+
ylab("rel.abundance [%]")+
xlab("")+
theme(legend.position = "none")+
scale_fill_manual(values=c("#1f78b4","#a6cee3"))
plot1
ENDOANOVA<-aov(value~Genotype+variable, data=Endo_table_melt)
summary(ENDOANOVA) #sig 1.03e-05 ***
#only keep Endozoicmonas
Endo_Control_PHY_rel<-subset_taxa(PHYLOSEQ_TABLE_control, Genus=="D_5__Endozoicomonas")
Endo_Control_PHY_rel
#### Endozoicomonas frequency ####
Endo_freq<-psmelt(Endo_Control_PHY_rel)
head(Endo_freq)
ANOVA<-aov(Abundance~Treatment+SamplingTimepoint, data=Endo_freq)
summary(ANOVA)
ANOVA<-aov(Abundance~Treatment*SamplingTimepoint, data=Endo_freq)
summary(ANOVA)
ANOVA<-aov(Abundance~Genotype, data=Endo_freq)
summary(ANOVA)
ANOVA<-aov(Abundance~Treatment*SamplingTimepoint*Genotype, data=Endo_freq)
summary(ANOVA)
ANOVA<-aov(Abundance~Treatment*SamplingTimepoint, data=Endo_freq)
summary(ANOVA)
ANOVA<-aov(Abundance~Genotype, data=Endo_freq)
summary(ANOVA)
ANOVA<-aov(Abundance~Treatment*SamplingTimepoint, data=Endo_freq)
summary(ANOVA)
capture.output(summary(ANOVA), file="Endo_freq_TreatTime.doc")
ANOVA<-aov(Abundance~Genotype, data=Endo_freq)
summary(ANOVA)
capture.output(summary(ANOVA), file="Endo_freq_Genotype.doc")
ANOVA<-aov(Abundance~Treatment*Timepoint+Error(Genotype), data=Endo_freq)
ANOVA<-aov(Abundance~Treatment*SamplingTimepoint+Error(Genotype), data=Endo_freq)
summary(ANOVA)
capture.output(summary(ANOVA), file="Endo_freq_withinGenotype.doc")
ANOVA<-aov(Abundance~Treatment+SamplingTimepoint, data=Endo_freq)
summary(ANOVA)
ANOVA<-aov(Abundance~Treatment*SamplingTimepoint, data=Endo_freq)
summary(ANOVA)
capture.output(summary(ANOVA), file="Endo_freq_TreatTime.doc")
ANOVA<-aov(Abundance~Genotype, data=Endo_freq)
summary(ANOVA)
capture.output(summary(ANOVA), file="Endo_freq_Genotype.doc")
ANOVA<-aov(Abundance~Treatment*SamplingTimepoint+Error(Genotype), data=Endo_freq)
summary(ANOVA)
capture.output(summary(ANOVA), file="Endo_freq_withinGenotype.doc")
ANOVA<-aov(Abundance~Treatment*SamplingTimepoint, data=Endo_freq)
summary(ANOVA)
ANOVA<-aov(Abundance~Genotype, data=Endo_freq)
summary(ANOVA)
ANOVA<-aov(Abundance~Treatment*SamplingTimepoint+Error(Genotype), data=Endo_freq)
summary(ANOVA)
ANOVA<-aov(Abundance~Treatment+Error(Genotype), data=Endo_freq)
summary(ANOVA)
capture.output(summary(ANOVA), file="Endo_freq_withinGenotype.doc")
load(file="PHYLOSEQ_TABLE_Count.RData")
PHYLOSEQ_TABLE_control_count=subset_samples(PHYLOSEQ_TABLE_count, Treatment!="field_control")
PHYLOSEQ_TABLE_control_count
Endo_Control_PHY_count<-subset_taxa(PHYLOSEQ_TABLE_control_count, Genus=="D_5__Endozoicomonas")
Endo_Control_PHY_count
#### Alpha diversity ####
Endo_Control_PHY_count
plot<-plot_richness(Endo_Control_PHY_count, x="Treatment", measures=c("Shannon","Observed"))+
geom_boxplot()+
theme_classic()
plot
pdf('ALPHA_ENDO.pdf', width=6, height=6)
print(plot)
graphics.off()
plot<-plot_richness(CORE_count, x="Genotype", measures=c("Shannon","Observed"))+
geom_boxplot()+
theme_classic()
plot
plot<-plot_richness(Endo_Control_PHY_count, x="Genotype", measures=c("Shannon","Observed"))+
geom_boxplot()+
theme_classic()
plot
pdf('ALPHA_ENDOGENOTYPE.pdf', width=6, height=6)
print(plot)
graphics.off()
RICHNESS<-estimate_richness(Endo_Control_PHY_count, split=TRUE, measures=c("Shannon","Observed"))
RICHNESS<-as.data.frame(RICHNESS)
RICHNESS<-tibble::rownames_to_column(as.data.frame(RICHNESS), var="Sample_ID")
Richness_table<-right_join(METADATA, RICHNESS, by="Sample_ID")
# treatment nor SamplingTimepoint has no overall effect alpha diversity (Endozoicomonas)
model1<-aov((Shannon)~Treatment*SamplingTimepoint, data=Richness_table)
summary(model1) #not significant
# Effect of Genotype on the Endozoicomoas diversity
model1<-aov((Shannon)~Genotype, data=Richness_table)
summary(model1) #p=0.0452 *  significant
# Effect of Genotype on the Endozoicomoas diversity
model1<-aov((Shannon)~Genotype, data=Richness_table)
summary(model1) #p=0.0452 *  significant
# Effect of Genotype on the Endozoicomoas diversity
model1<-aov((Observed)~Genotype, data=Richness_table)
summary(model1) #sign p=1.14e-08 ***
# treatment nor SamplingTimepoint has no overall effect alpha diversity (Endozoicomonas)
model1<-aov((Shannon)~SamplingTimepoint+Error(Treatment), data=Richness_table)
summary(model1) #not significant
# Richness
# treatment nor SamplingTimepoint has no overall effect alpha diversity (Endozoicomonas)
model1<-aov((Observed)~SamplingTimepoint+Error(Treatment), data=Richness_table)
summary(model1) #not significant
#### ADONIS & BETA DISPERSION ####
# Adonis = permutational Multivariate Analysis of variance using distance matrices
### using adonis2 ### - this is the way to go!
df=as(sample_data(PHYLOSEQ_TABLE_control), 'data.frame')
d=phyloseq::distance(PHYLOSEQ_TABLE_control,'bray')
ADONIS<-adonis(d~Genotype, data=df, permutations = 10000, method = "bray")
ADONIS
#### ADONIS ####
# Adonis = permutational Multivariate Analysis of variance using distance matrices
### using adonis2 ### - this is the way to go!
df=as(sample_data(PHYLOSEQ_TABLE_control), 'data.frame')
d=phyloseq::distance(PHYLOSEQ_TABLE_control,'bray')
ADONIS<-adonis(d~Genotype, data=df, permutations = 10000, method = "bray")
ADONIS #sign -> sign - endozoicomonas community varies significanlty between coral host genotypes
capture.output(ADONIS,file="Adonis_EndozoicomonasGenotypeControl.doc")
perm<-how(nperm=10000)
setBlocks(perm)<-with(df, Genotype)
ADONIS2<-adonis2(d~Treatment, data=df, permutations = perm, method = "bray")
ADONIS2 #not sign -> no shift in the microbial community between treatments within a genotype
capture.output(ADONIS2,file="Adonis2_TimeeffectEndoGenotypeControl.doc")
#### ADONIS ####
# Adonis = permutational Multivariate Analysis of variance using distance matrices
### using adonis2 ### - this is the way to go!
df=as(sample_data(Endo_Control_PHY_rel), 'data.frame')
d=phyloseq::distance(Endo_Control_PHY_rel,'bray')
ADONIS<-adonis(d~Genotype, data=df, permutations = 10000, method = "bray")
ADONIS #sign -> sign - endozoicomonas community varies significanlty between coral host genotypes
capture.output(ADONIS,file="Adonis_EndozoicomonasGenotypeControl.doc")
perm<-how(nperm=10000)
setBlocks(perm)<-with(df, Genotype)
ADONIS2<-adonis2(d~Treatment, data=df, permutations = perm, method = "bray")
ADONIS2 #not sign -> no shift in the microbial community between treatments within a genotype
#### CCA ####
ORDCCA<-ordinate(Endo_Control_PHY_rel,"CCA", formula = ~Genotype)
plot_ordination(Endo_Control_PHY_rel, ORDCCA,color = "Genotype")
ORDCCA # Genotype explains 27.23% of observed variability
library(vegan)
anova.cca(ORDCCA,by="term", permutations = 10000) # Genotype also highly sign p=0.000999 ***
library(ggplot2)
library(phyloseq)
#load data
load(file="PHYLOSEQ_TABLE.RData")
load(file="PHYLOSEQ_TABLE_Count.RData")
#remove field_control samples
PHYLOSEQ_TABLE_control=subset_samples(PHYLOSEQ_TABLE, Treatment!="field_control")
PHYLOSEQ_TABLE_control
PHYLOSEQ_TABLE_control_count=subset_samples(PHYLOSEQ_TABLE_count, Treatment!="field_control")
PHYLOSEQ_TABLE_control_count
#only keep Endozoicmonas
Endo_Control_PHY_rel<-subset_taxa(PHYLOSEQ_TABLE_control, Genus=="D_5__Endozoicomonas")
Endo_Control_PHY_rel
Endo_Control_PHY_count<-subset_taxa(PHYLOSEQ_TABLE_control_count, Genus=="D_5__Endozoicomonas")
Endo_Control_PHY_count
#### Figure 3b - dbRDA ####
Endo_Control_PHY_rel = transform_sample_counts(PHYLOSEQ_TABLE_control_count, function(x)100*x/sum(x))
head(sample_data(Endo_Control_PHY_rel))
# transfrom metadata z-score
TEMP<-read.csv("sample_metadata_new2.csv", header = TRUE, sep=",", dec=".", strip.white = TRUE)
str(TEMP)
TEMP<-TEMP %>% filter(Treatment != "field_control")
TEMP
TEMP_stand<-decostand(TEMP[,c(9,10,12,13)], method = "standardize", na.rm=TRUE)
TEMP_stand
# upload z-score metadata
Sample_ID<-TEMP$Sample_ID
newMETA<-cbind(TEMP_stand, Sample_ID)
str(newMETA)
rownames(newMETA)<-newMETA$Sample_ID
META<-inner_join(TEMP, newMETA, by="Sample_ID")
rownames(META)<-META$Sample_ID
METADATA<-sample_data(META)
sample_data(Endo_Control_PHY_rel)<-METADATA
sample_data(Endo_Control_PHY_rel)
# dbRDA
ORDCCA<-ordinate(Endo_Control_PHY_rel,"CAP",formula = ~ Genotype+Treatment+PSYield.y+Chla.y+Zoox.y+Protein.y)
ORDCCA # explains 47.52 % of observed variation
ORDCCA<-ordinate(Endo_Control_PHY_rel,"CAP",formula = ~ Genotype)
ORDCCA
# dbRDA
ORDCCA<-ordinate(Endo_Control_PHY_rel,"CAP",formula = ~ Genotype+Treatment+PSYield.y+Chla.y+Zoox.y+Protein.y)
ORDCCA # explains  % of observed variation
ORDCCA<-ordinate(Endo_Control_PHY_rel,"CAP",formula = ~ Genotype)
ORDCCA
ANOVA<-anova.cca(ORDCCA, by="term", permutations = 10000) #
ANOVA #sig
#### CCA ####
ORDCCA<-ordinate(Endo_Control_PHY_rel,"CCA", formula = ~Genotype)
plot_ordination(Endo_Control_PHY_rel, ORDCCA,color = "Genotype")
ORDCCA # Genotype explains 27.23% of observed variability
library(vegan)
anova.cca(ORDCCA,by="term", permutations = 10000) # Genotype also highly sign p=0.000999 ***
p0 = plot_ordination(Endo_Control_PHY_rel, ORDCCA, color="Genotype")+
scale_color_brewer(palette = "Paired")+
theme_classic(base_size = 16, base_family = "Helvetica")+
geom_hline(yintercept=c(0,0), linetype="dotted")+
geom_vline(xintercept=c(0,0), linetype="dotted")+
geom_point(size=3)+
xlab("db RDA1 [23.5%]")+
ylab("db RDA2 [4.3%]")
p0
p0
p0 = plot_ordination(Endo_Control_PHY_rel, ORDCCA, color="Genotype")+
scale_color_brewer(palette = "Paired")+
theme_classic(base_size = 16, base_family = "Helvetica")+
geom_hline(yintercept=c(0,0), linetype="dotted")+
geom_vline(xintercept=c(0,0), linetype="dotted")+
geom_point(size=3)
p0
postscript(file = "CCAplot_EndoGenotype.eps", width =6, height = 5)
print(p0)
dev.off()
pdf('CCAplot_EndoGenotype.pdf', width=6, height=5)
print(p0)
graphics.off()
#load data
load(file="PHYLOSEQ_TABLE.RData")
load(file="PHYLOSEQ_TABLE_Count.RData")
#remove field_control samples
PHYLOSEQ_TABLE_control=subset_samples(PHYLOSEQ_TABLE, Treatment!="field_control")
PHYLOSEQ_TABLE_control
PHYLOSEQ_TABLE_control_count=subset_samples(PHYLOSEQ_TABLE_count, Treatment!="field_control")
PHYLOSEQ_TABLE_control_count
### Pathobiome and Endozoicomnas ####
library(phyloseq)
#load data
load(file="PHYLOSEQ_TABLE.RData")
load(file="PHYLOSEQ_TABLE_Count.RData")
#remove field_control samples
PHYLOSEQ_TABLE_control=subset_samples(PHYLOSEQ_TABLE, Treatment!="field_control")
PHYLOSEQ_TABLE_control
PHYLOSEQ_TABLE_control_count=subset_samples(PHYLOSEQ_TABLE_count, Treatment!="field_control")
PHYLOSEQ_TABLE_control_count
load(file="PHYLOSEQ_TABLE.RData")
library(phyloseq)
library(ggplot2)
library(dplyr)
library(tidyr)
library(tibble)
library(microbiome)
PHYLOSEQ_TABLE=subset_samples(PHYLOSEQ_TABLE, Treatment!="field_control")
PHYLOSEQ_TABLE
Other_PHY<-subset_taxa(PHYLOSEQ_TABLE, Genus!="D_5__Endozoicomonas")
Other_PHY #96 samples
Other_PHY_rel = transform_sample_counts(Other_PHY, function(x)100*x/sum(x))
METADATA<-as(sample_data(Other_PHY_rel), "data.frame")
METADATA<-rownames_to_column(METADATA, var="Sample_ID")
OTU_table<-as(otu_table(Other_PHY_rel), "matrix")
if(taxa_are_rows(Other_PHY_rel)){OTU_table <- t(OTU_table)}
OTU_table_df = as.data.frame(OTU_table)
OTU_table_df<-rownames_to_column(OTU_table_df, var="Sample_ID")
# join datasets
TEM<-read.csv("Grouping_zeropointfive_threshold.csv", header = TRUE, sep = ",", dec=".", strip.white=TRUE)
METAnew<-full_join(TEM,METADATA,by="Sampling_Date")
METAnew
library(dplyr)
library(tidyr)
OTU_table_IndVal<-right_join(METAnew, OTU_table_df, by="Sample_ID")
library(labdsv)
library(MASS)
library(vegan)
library(cluster)
library(indicspecies)
library(permute)
# install required packages
install.packages("ggplot2")
install.packages("dplyr")
install.packages("tidyr")
install.packages("tibble")
install.packages("ggpubr")
install.packages("raster")
install.packages("GGally")
install.packages("labdsv")
install.packages("MASS")
install.packages("cluster")
install.packages("indicspecies")
install.packages("permute")
install.packages("data.table")
install.packages("caret")
install.packages("kernlab")
install.packages("e1071")
library(labdsv)
install.packages("labdsv")
library(phyloseq)
load(file="PHYLOSEQ_TABLE.RData")
library(phyloseq)
library(ggplot2)
library(dplyr)
library(tidyr)
library(tibble)
library(microbiome)
PHYLOSEQ_TABLE=subset_samples(PHYLOSEQ_TABLE, Treatment!="field_control")
PHYLOSEQ_TABLE
Other_PHY<-subset_taxa(PHYLOSEQ_TABLE, Genus!="D_5__Endozoicomonas")
Other_PHY #96 samples
Other_PHY_rel = transform_sample_counts(Other_PHY, function(x)100*x/sum(x))
METADATA<-as(sample_data(Other_PHY_rel), "data.frame")
METADATA<-rownames_to_column(METADATA, var="Sample_ID")
OTU_table<-as(otu_table(Other_PHY_rel), "matrix")
if(taxa_are_rows(Other_PHY_rel)){OTU_table <- t(OTU_table)}
OTU_table_df = as.data.frame(OTU_table)
OTU_table_df<-rownames_to_column(OTU_table_df, var="Sample_ID")
OTU_table_IndVal<-right_join(METADATA, OTU_table_df, by="Sample_ID")
head(OTU_table_IndVal)
METADATA<-as(sample_data(Other_PHY_rel), "data.frame")
METADATA<-rownames_to_column(METADATA, var="Sample_ID")
View(METADATA)
OTU_table<-as(otu_table(Other_PHY_rel), "matrix")
if(taxa_are_rows(Other_PHY_rel)){OTU_table <- t(OTU_table)}
OTU_table_df = as.data.frame(OTU_table)
OTU_table_df<-rownames_to_column(OTU_table_df, var="Sample_ID")
# join datasets
library(dplyr)
library(tidyr)
OTU_table_IndVal<-right_join(METADATA, OTU_table_df, by="Sample_ID")
View(OTU_table_IndVal)
#indval
library(labdsv)
library(MASS)
library(vegan)
library(cluster)
library(indicspecies)
library(permute)
(INDVAL_OTUs_species_GC=(as.data.frame(OTU_table_IndVal[,15:5003])))
Other_PHY #96 samples
(INDVAL_OTUs_species_GC=(as.data.frame(OTU_table_IndVal[,14:2783])))
#Cluster
(INDVAL_Groups_Origin_GC=(as.character(OTU_table_IndVal$Treatment)))
INDVAL_Origin_GC=multipatt(INDVAL_OTUs_species_GC, INDVAL_Groups_Origin_GC, func="IndVal.g", duleg=TRUE, control=how(nperm=1000))
summary(INDVAL_Origin_GC, indvalcomp=TRUE)
##### Figure 6 ####
# IndVal others
load(file="PHYLOSEQ_TABLE.RData")
library(phyloseq)
library(ggplot2)
library(dplyr)
library(tidyr)
library(tibble)
library(microbiome)
PHYLOSEQ_TABLE=subset_samples(PHYLOSEQ_TABLE, Treatment!="field_control")
PHYLOSEQ_TABLE
Other_PHY<-subset_taxa(PHYLOSEQ_TABLE, Genus!="D_5__Endozoicomonas")
Other_PHY #96 samples
Other_PHY_rel = transform_sample_counts(Other_PHY, function(x)100*x/sum(x))
METADATA<-as(sample_data(Other_PHY_rel), "data.frame")
METADATA<-rownames_to_column(METADATA, var="Sample_ID")
OTU_table<-as(otu_table(Other_PHY_rel), "matrix")
if(taxa_are_rows(Other_PHY_rel)){OTU_table <- t(OTU_table)}
OTU_table_df = as.data.frame(OTU_table)
OTU_table_df<-rownames_to_column(OTU_table_df, var="Sample_ID")
# join datasets
library(dplyr)
library(tidyr)
OTU_table_IndVal<-right_join(METADATA, OTU_table_df, by="Sample_ID")
#indval
library(labdsv)
library(MASS)
library(vegan)
library(cluster)
library(indicspecies)
library(permute)
(INDVAL_OTUs_species_GC=(as.data.frame(OTU_table_IndVal[,14:2783])))
#Cluster
(INDVAL_Groups_Origin_GC=(as.character(OTU_table_IndVal$Treatment)))
INDVAL_Origin_GC=multipatt(INDVAL_OTUs_species_GC, INDVAL_Groups_Origin_GC, func="IndVal.g", duleg=TRUE, control=how(nperm=1000))
summary(INDVAL_Origin_GC, indvalcomp=TRUE)
head(summary.multipatt(INDVAL_Origin_GC, alpha = 0.01, indvalcomp=TRUE)) #At=0.80, Bt=0.80
IndValdf<-data.frame(INDVAL_Origin_GC$sign)
IndValdf<-rownames_to_column(IndValdf, var="ASV_ID")
IndValdf<-IndValdf %>% filter(p.value<=0.01) %>% dplyr:: rename(low=s.low) %>%
dplyr:: rename(average=s.average)%>%
dplyr:: rename(high=s.high)
IndValdf<-IndValdf%>% dplyr::select(-index,-p.value,-stat)
library(reshape)
IndVallong<-melt(IndValdf)
indicatorNUMBER<-IndVallong %>% group_by(variable,value) %>% summarise(numberofOTUs=n())
install.packages("labdsv")
install.packages("MASS")
install.packages("cluster")
install.packages("indicspecies")
install.packages("permute")
install.packages("data.table")
##### Figure 6 ####
# IndVal others
load(file="PHYLOSEQ_TABLE.RData")
library(phyloseq)
library(ggplot2)
library(dplyr)
library(tidyr)
library(tibble)
library(microbiome)
PHYLOSEQ_TABLE=subset_samples(PHYLOSEQ_TABLE, Treatment!="field_control")
PHYLOSEQ_TABLE
Other_PHY<-subset_taxa(PHYLOSEQ_TABLE, Genus!="D_5__Endozoicomonas")
Other_PHY #96 samples
Other_PHY_rel = transform_sample_counts(Other_PHY, function(x)100*x/sum(x))
METADATA<-as(sample_data(Other_PHY_rel), "data.frame")
METADATA<-rownames_to_column(METADATA, var="Sample_ID")
OTU_table<-as(otu_table(Other_PHY_rel), "matrix")
if(taxa_are_rows(Other_PHY_rel)){OTU_table <- t(OTU_table)}
OTU_table_df = as.data.frame(OTU_table)
OTU_table_df<-rownames_to_column(OTU_table_df, var="Sample_ID")
# join datasets
library(dplyr)
library(tidyr)
OTU_table_IndVal<-right_join(METADATA, OTU_table_df, by="Sample_ID")
#indval
library(labdsv)
library(MASS)
library(vegan)
library(cluster)
library(indicspecies)
library(permute)
(INDVAL_OTUs_species_GC=(as.data.frame(OTU_table_IndVal[,14:2783])))
#Cluster
(INDVAL_Groups_Origin_GC=(as.character(OTU_table_IndVal$Treatment)))
INDVAL_Origin_GC=multipatt(INDVAL_OTUs_species_GC, INDVAL_Groups_Origin_GC, func="IndVal.g", duleg=TRUE, control=how(nperm=1000))
summary(INDVAL_Origin_GC, indvalcomp=TRUE)
head(summary.multipatt(INDVAL_Origin_GC, alpha = 0.05, indvalcomp=TRUE)) #At=0.80, Bt=0.80
(INDVAL_OTUs_species_GC=(as.data.frame(OTU_table_IndVal[,14:2783])))
#Cluster
(INDVAL_Groups_Origin_GC=(as.character(OTU_table_IndVal$Treatment)))
INDVAL_Origin_GC=multipatt(INDVAL_OTUs_species_GC, INDVAL_Groups_Origin_GC, func="IndVal.g", duleg=TRUE, control=how(nperm=1000))
summary(INDVAL_Origin_GC, indvalcomp=TRUE)
head(summary.multipatt(INDVAL_Origin_GC, alpha = 0.05, indvalcomp=TRUE)) #At=0.80, Bt=0.80
IndValdf<-data.frame(INDVAL_Origin_GC$sign)
IndValdf<-rownames_to_column(IndValdf, var="ASV_ID")
IndValdf<-IndValdf %>% filter(p.value<=0.05) %>% dplyr:: rename(control=s.control) %>%
dplyr:: rename(acute_stress=s.stress_ambient)%>%
dplyr:: rename(cumulative_stress=s.stress_2100)
IndValdf<-IndValdf%>% dplyr::select(-index,-p.value,-stat)
library(reshape)
install.packages("reshape")
library(reshape)
IndVallong<-melt(IndValdf)
indicatorNUMBER<-IndVallong %>% group_by(variable,value) %>% summarise(numberofOTUs=n())
## prep Graphs ####
# Define the taxa you want like this:
goodTaxa = (IndValdf$ASV_ID)
goodTaxa
allTaxa = taxa_names(PL_MI)
allTaxa <- allTaxa[(allTaxa %in% goodTaxa)]
## prep Graphs ####
# Define the taxa you want like this:
goodTaxa = (IndValdf$ASV_ID)
goodTaxa
allTaxa = taxa_names(Other_PHY_rel)
allTaxa <- allTaxa[(allTaxa %in% goodTaxa)]
ex1 = prune_taxa(allTaxa, Other_PHY_rel)
# new phyloseq object with just the taxa you kept.
ex1 #110taxa
OTUTABLE<-as(otu_table(ex1), "matrix")
OTUTABLE<-as.data.frame(OTUTABLE)
OTUTABLE<-rownames_to_column(OTUTABLE, var="ASV_ID")
test<-inner_join(IndVallong,OTUTABLE, by=c("ASV_ID"))
test1<-test%>%gather("Sample","Abundance",4:33)
test2<-test1%>% group_by(variable,value,Sample) %>% summarise(SUM=sum(Abundance))
META<-METAnew %>% dplyr::select(Sampling_Date,Sample_ID) %>% dplyr::rename(Sample=Sample_ID)
test3<-inner_join(META,test2, by=c("Sample"))
